//$TRKCALC JOB NOTIFY=&SYSUID,COND=(4,LT)
/*ROUTE  PRINT U2
//*
//ASMACLG  PROC
//C        EXEC PGM=ASMA90,PARM=TERM
//SYSLIB   DD  DSN=JES2.V250.TEST.MODMAC,DISP=SHR
//         DD  DSN=JES2.V250.TEST.HASPSRC,DISP=SHR
//         DD  DSN=SYS1.MACLIB,DISP=SHR
//         DD  DSN=SYS1.MODGEN,DISP=SHR
//SYSUT1   DD  DSN=&&SYSUT1,SPACE=(4096,(120,120),,,ROUND),
//             UNIT=SYSALLDA,DCB=BUFNO=1
//SYSTERM  DD  SYSOUT=*
//SYSPRINT DD  SYSOUT=*
//SYSLIN   DD  DSN=&&OBJ,SPACE=(3040,(40,40),,,ROUND),
//             UNIT=SYSALLDA,DISP=(MOD,PASS),
//             DCB=(BLKSIZE=3040,LRECL=80,RECFM=FB,BUFNO=1)
//L        EXEC PGM=HEWL,PARM='MAP,LET,LIST',COND=(8,LT,C)
//SYSLIN   DD  DSN=&&OBJ,DISP=(OLD,DELETE)
//         DD  DDNAME=SYSIN
//SYSLMOD  DD  DISP=(,PASS),UNIT=SYSALLDA,SPACE=(CYL,(1,1,1)),
//             DSN=&&GOSET(GO)
//SYSUT1   DD  DSN=&&SYSUT1,SPACE=(1024,(120,120),,,ROUND),
//             UNIT=SYSALLDA,DCB=BUFNO=1
//SYSTERM  DD  SYSOUT=*
//SYSPRINT DD  SYSOUT=*
//G        EXEC PGM=*.L.SYSLMOD,COND=((8,LT,C),(8,LT,L))
//SYSPRINT DD  SYSOUT=*
//PEND     PEND
//*
//ASM    EXEC  ASMACLG
//C.SYSIN  DD  *
TRKCALC  TITLE ' '
TRKCALC  CSECT
         SPACE 1
R0       EQU   0
R1       EQU   1
R2       EQU   2
R3       EQU   3
R4       EQU   4
R5       EQU   5
R6       EQU   6
R7       EQU   7
R8       EQU   8
R9       EQU   9
R10      EQU   10
R11      EQU   11
R12      EQU   12
R13      EQU   13
R14      EQU   14
R15      EQU   15
         SPACE 1
         SPACE 1                                                  ONL01
         USING *,R12               BASE REGISTER
         STM   R14,R12,12(R13)     STANDARD REGISTER SAVE
         LR    R12,R15             LOAD BASE REG
         LR    R2,R1               SAVE PARAMETER REGISTER
         GETMAIN R,LV=4096         GET STORAGE FOR SAVEAREA
         ST    R1,8(R13)           FORWARD POINTER
         ST    R13,4(R1)           BACKWARD POINTER
         LR    R13,R1              MOVE ADDR TO R1
         SPACE 1
         OPEN  (HASPCKPT,INPUT)
         SPACE 1
         L     R5,DCBDEBAD-IHADCB+HASPCKPT  DEB ADDRESS
         N     R5,=A(X'00FFFFFF') MASK OFF FLAG BYTE
         SPACE 1
         USING DEBBASIC,R5
         LA    R5,DEBBASND        END OF BASIC = DEBDASD
         USING DEBDASD,R5
         SPACE 1
         L     R5,DEBUCBAD        LOAD UCB ADDRESS
         N     R5,=A(X'00FFFFFF') MASK OFF FLAG BYTE
         DROP  R5
         SPACE 1
         LA    R14,CKBCKRLN       LENGTH OF LOCK AND CHECK RECORDS
         TRKCALC FUNCTN=TRKBAL,UCB=(R5),R=2,K=0,DD=(R14),              +
               REGSAVE=YES RETURNS REMAINING BYTES IN R0
         SPACE 1
         L     R14,$MASTERL       LENGTH OF MASTER RECORD
         TRKCALC FUNCTN=TRKBAL,UCB=(R5),R=3,K=0,DD=(R14),BALANCE=(R0), +
               REGSAVE=YES RETURNS REMAINING BYTES IN R0
         SPACE 1
         TRKCALC FUNCTN=TRKCAP,UCB=(R5),R=4,K=0,DD=4096,BALANCE=(R0),  +
               REGSAVE=YES RETURNS # RECORDS THAT WILL FIT ON TRACK
         SPACE 1
         LH    R14,$CLRECN        NUMBER OF CHANGE LOG RECORDS
         SR    R0,R14             NUMBER OF FILLER RECORDS TO
*                                  FILL OUT THE TRACK
         BNM   SETFUDGE
         SPACE 1
*        IF WE GET HERE, THERE ARE MORE CHANGE LOG RECORDS THAN
*        WILL FIT ON THE CURRENT TRACK.
         SPACE 1
         LPR   R4,R0              NUMBER OF LOG RECORDS REMAINING
         SPACE 1
         TRKCALC FUNCTN=TRKCAP,UCB=(R5),R=1,K=0,DD=4096,BALANCE=(R0),  +
               REGSAVE=YES # RECORDS THAT WILL FIT ON FULL TRACK
         SPACE 1
         SR    R4,R0
         BP    *-2
         SPACE 1
         LPR   R0,R4
         SPACE 1
SETFUDGE DS    0H
         EX    0,*
         SPACE 3
$CLRECN  DC    H'21'              NUMBER OF CHANGE LOG RECORDS
CKBCKRLN EQU   372                LENGTH OF LOCK AND CHECK RECORDS
$MASTERL DC    F'13068'
HASPCKPT DCB   DDNAME=HASPCKPT,DSORG=PS,MACRF=(RCP),                   X
               RECFM=U,BLKSIZE=4096,NCP=25
         SPACE 3
         LTORG ,
         EJECT
         DCBD   DSORG=PS
         EJECT
         IEZDEB LIST=YES
         EJECT
IEFUCBOB DSECT ,
         IEFUCBOB DEVCLAS=DA
         SPACE 3
         END
//G.SYSPRINT DD SYSOUT=A
//HASPCKPT DD  DSN=SYS1.HASPCKPT,DISP=SHR,
//             UNIT=SYSDA,VOL=SER=MVSXAT
